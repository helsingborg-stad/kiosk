var Helsingborg;Helsingborg=Helsingborg||{},Helsingborg.Search=Helsingborg.Search||{},Helsingborg.Search.Search=function(e){function t(){e(function(){this.handleEvents()}.bind(this))}var i,n,a,s,r,o,l,c=!0,d=0,u=100,h=0,p=".search-result",f=".pagination",g=!1,m=1;return t.prototype.request=function(t){e.post(ajaxurl,t,function(t){h++,t=e.parseJSON(t),this.handleResponse(t)}.bind(this))},t.prototype.handleResponse=function(t){c?e(".loading-results").remove():e(p).empty(),i=void 0!==t.queries.nextPage?t.queries.nextPage[0]:void 0,a=void 0!==t.queries.previousPage?t.queries.previousPage[0]:void 0,r=void 0!==t.queries.request?t.queries.request[0]:void 0,l=r.count,o=r.totalResults,o>0?(this.searchInfo(t),this.outputResults(t),c?this.setupInfiniteScroll():this.setupPagination()):is404?(e('input[name="s"]').val(""),e(".section-search-result").hide()):this.emptyResult()},t.prototype.emptyResult=function(){e(p).append(e(p).find("li").length>0?"Inga fler resultat att visa.":"Din sökning gav inga resultat.")},t.prototype.setupInfiniteScroll=function(){e(".infinite-scroll-load-more").hide(),d=e(p).height()+e(p).offset().top-e(window).height()+u,n={action:"search",keyword:query,index:i.startIndex.toString()},e(window).on("scroll.infiniteScrolling",function(){var t=e(window).scrollTop();t>=d&&(e(window).off("scroll.infiniteScrolling"),2!=h?(e(p).append('<li class="loading-results"><i class="hbg-loading">Läser in resultat…</i></li>'),this.request(n)):e(".infinite-scroll-load-more").show())}.bind(this)),e(document).off("click",'[data-action="infinite-scroll-more"]'),e(document).on("click",'[data-action="infinite-scroll-more"]',function(t){t.preventDefault(),e(window).off("scroll.infiniteScrolling"),e(p).append('<li class="loading-results"><i class="hbg-loading">Läser in resultat…</i></li>'),e(".infinite-scroll-load-more").hide(),this.request(n)}.bind(this))},t.prototype.setupPagination=function(){if(void 0!==a&&(s={action:"search",keyword:query,index:a.startIndex.toString()},e('[data-action="prev-page"]').show()),void 0!==i&&(n={action:"search",keyword:query,index:i.startIndex.toString()},e('[data-action="next-page"]').show()),o>l&&g!==!0){for(var t=o/l,r=1;t>=r;r++)e(".pagination li:last-child").before(r==m?'<li class="current"><a href="#" data-paginate-index="'+r+'">'+r+"</a></li>":'<li><a href="#" data-paginate-index="'+r+'">'+r+"</a></li>");g=!0,this.setPaginationCurrent()}e(".pagination").show()},t.prototype.searchInfo=function(t){var i='<span class="search-hits">'+t.searchInformation.formattedTotalResults+'</span> träffar på <span class="search-query">'+unescape(t.queries.request[0].searchTerms).replace(/\\"/g,'"')+"</span> inom Helsingborg.se";e(".search-hits-info").html(i)},t.prototype.outputResults=function(t){e.each(t.items,function(t,i){var n=0;i.pagemap&&(n=i.pagemap.metatags[0]);var a=e('<li class="search-result-item"><div class="search-result-item-content"></div></li>'),s=this.getDateModified(i);s&&a.find(".search-result-item-content").append('<span class="search-result-item-date">'+s+"</span>"),a.find(".search-result-item-content").append("PDF/Adobe Acrobat"==i.fileFormat?'<h3><a target="_blank" href="'+i.link+'" class="pdf-item">'+i.htmlTitle+"</a></h3>":"Microsoft Word"==i.fileFormat?'<h3><a target="_blank" href="'+i.link+'" class="word-item">'+i.htmlTitle+"</a></h3>":'<h3><a href="'+i.link+'" class="link-item">'+i.htmlTitle+"</a></h3>"),a.find(".search-result-item-content").append("<p>"+e.trim(i.htmlSnippet)+"</p>"),a.find(".search-result-item-content").append('<div class="search-result-item-info"></div>'),a.find(".search-result-item-info").append('<span class="search-result-item-url"><i class="fa fa-globe"></i> <a href="'+i.link+'">'+i.htmlFormattedUrl+"</a></span>"),e(p).append(a)}.bind(this))},t.prototype.getDateModified=function(e){var t=0;e.pagemap&&(t=e.pagemap.metatags[0]);var i=null;return void 0!==t.moddate?i=this.convertDate(t.moddate):void 0!==t.pubdate?i=this.convertDate(t.pubdate):void 0!==t["last-modified"]&&(i=t["last-modified"]),i},t.prototype.convertDate=function(e){var t,i,n;return e.length>20?(t=e.substring(2,6),i=e.substring(6,8),n=e.substring(8,10),i=this.convertDateToMonth(i),n+" "+i+" "+t):11==e.length?(e=e.replace("May","Maj"),e=e.replace("Oct","Okt")):8==e.length?(t=e.substring(0,4),i=e.substring(4,6),n=e.substring(6,e.length),i=this.convertDateToMonth(i),n+" "+i+" "+t):""},t.prototype.convertDateToMonth=function(e){switch(e){case"01":return"Jan";case"02":return"Feb";case"03":return"Mar";case"04":return"Apr";case"05":return"Maj";case"06":return"Jun";case"07":return"Jul";case"08":return"Aug";case"09":return"Sep";case"10":return"Okt";case"11":return"Nov";case"12":return"Dec"}},t.prototype.browse=function(e){if("next"==e)m++,this.request(n);else if("prev"==e)m--,this.request(s);else{m=e;var t=10*m+1,i={action:"search",keyword:query,index:t};this.request(i)}this.setPaginationCurrent()},t.prototype.setPaginationCurrent=function(){e(f).find("li.current").removeClass("current"),e(f).find("li").filter(function(){return e(this).text()==m}).addClass("current"),m>3?(e(f).find("li").show(),e(f).find("li:gt("+(m+2)+")").hide(),e(f).find("li:lt("+(m-2)+")").hide(),e(f).find("li:first-child").show(),e(f).find("li:last-child").show()):(e(f).find("li:gt(5)").hide(),e(f).find("li:last-child").show())},t.prototype.handleEvents=function(){e(document).ready(function(){query.length&&this.request({action:"search",keyword:query,index:"1"})}.bind(this)),e('[data-action="next-page"]').on("click",function(t){t.preventDefault(),e(p).html('<li class="event-times-loading"><i class="hbg-loading">Läser in resultat…</i></li>'),e("html, body").animate({scrollTop:0},"fast"),this.browse("next")}.bind(this)),e('[data-action="prev-page"]').on("click",function(t){t.preventDefault(),e(p).html('<li class="event-times-loading"><i class="hbg-loading">Läser in resultat…</i></li>'),e("html, body").animate({scrollTop:0},"fast"),this.browse("prev")}.bind(this)),e(document).on("click","[data-paginate-index]",function(t){t.preventDefault(),e(p).html('<li class="event-times-loading"><i class="hbg-loading">Läser in resultat…</i></li>'),e("html, body").animate({scrollTop:0},"fast"),this.browse(e(t.target).data("paginate-index"))}.bind(this))},new t}(jQuery);