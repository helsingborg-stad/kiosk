function EventModel(e){e||(e={});var t=this;t.EventID=e.EventID,t.Date=e.Date,t.Name=e.Name,t.Description=e.Description,t.Link=e.Link,t.ImagePath=e.ImagePath,t.Location=e.Location,t.EventTypesName=e.EventTypesName}function TypeModel(e){e||(e={});var t=this;t.ID=e.ID,t.Name=e.EventTypesName}function EventPageModel(e,t){var n=this;n.selectedEventTypes=ko.observable(),n.events=ko.observableArray(ExtractModels(n,e,EventModel)),n.eventTypes=ko.observableArray(ExtractModels(n,t,TypeModel)),n.change=function(){jQuery("#selectedTypes").trigger("change")};var a=[{Type:"text",Name:"Fritext",Value:ko.observable(""),EventValue:function(e){return e.Name+e.Description}},{Type:"text",Name:"Plats",Value:ko.observable(""),EventValue:function(e){return null!=e.Location?e.Location:""}},{Type:"calendar",Name:"Startdatum",CalendarID:"datetimepickerstart",Value:ko.observable(""),EventValue:function(e){return null!=e.Date?e.Date:""}},{Type:"calendar",Name:"Slutdatum",CalendarID:"datetimepickerend",Value:ko.observable(""),EventValue:function(e){return null!=e.Date?e.Date:""}},{Type:"select",Name:"Evenemangstyp",Options:n.eventTypes,CurrentOption:n.selectedEventTypes,EventValue:function(e){return null!=e.EventTypesName?e.EventTypesName:""}}];n.filter=new FilterModel(a,n.events),n.pager=new PagerModel(n.filter.filteredEvents)}function PagerModel(e){var t=this;t.events=GetObservableArray(e),t.currentPageIndex=ko.observable(t.events().length>0?0:-1),t.currentPageSize=7,t.eventCount=ko.computed(function(){return t.events().length}),t.maxPageIndex=ko.computed(function(){var e=Math.ceil(t.events().length/t.currentPageSize)-1;return e}),t.pagerPages=function(){var e=t.maxPageIndex(),n=t.currentPageIndex(),a=5,r=0,l=0;2>n?(r=1,l=a):n+a>e?(r=e-a,l=e):(r=n-1,l=n+3);for(var i=new Array,o=r;l>=o;o++)i.push(o);return i},t.currentPageEvents=ko.computed(function(){var e=-1,n=t.currentPageIndex(),a=t.maxPageIndex();if(e=n>a?a:-1==n?a>-1?0:-2:n,e!=n)return e>=-1&&t.currentPageIndex(e),[];var r=t.currentPageSize,l=n*r,i=l+r;return t.renderPagers(),t.events().slice(l,i)}).extend({throttle:5}),t.currentStatus=function(e){return t.currentPageIndex()==e?"current":""},t.isHidden=function(e){return t.maxPageIndex()>=e?!0:!1},t.moveFirst=function(){t.changePageIndex(0)},t.movePrevious=function(){t.changePageIndex(t.currentPageIndex()-1)},t.moveNext=function(){t.changePageIndex(t.currentPageIndex()+1)},t.moveLast=function(){t.changePageIndex(t.maxPageIndex())},t.changePageIndex=function(e){0>e||e==t.currentPageIndex()||e>t.maxPageIndex()||t.currentPageIndex(e)},t.onPageSizeChange=function(){t.currentPageIndex(0)},t.renderPagers=function(){t.pagerPages()},t.renderNoEvents=function(){var e='<span data-bind="visible: pager.eventCount() == 0">Hittade inga event.</span>';$("div.NoEvents").html(e)}}function FilterModel(e,t){var n=this;n.events=GetObservableArray(t),n.filters=ko.observableArray(e),n.activeFilters=ko.computed(function(){for(var e=n.filters(),t=[],a=0;a<e.length;a++){var r=e[a];if(r.CurrentOption){var l=r.CurrentOption();if(null!=l){var i={Filter:r,IsFiltered:function(e,t){var n=e.CurrentOption();if(n){var a=e.EventValue(t);return-1==n.indexOf(a)}}};t.push(i)}}else if(r.Value){var o=r.Value();if(o&&""!=o&&null!=o){var i={Filter:r,IsFiltered:function(e,t){var n=e.Value();n=n.toUpperCase();var a=e.EventValue(t);if(a=a.toUpperCase(),"calendar"==e.Type){var r=new Date(n),l=new Date(a);return e.Name.indexOf("Start")>-1?r>l:l>r}return-1==a.indexOf(n)}};t.push(i)}}}return t}),n.filteredEvents=ko.computed(function(){var e=n.events(),t=n.activeFilters();if(0==t.length)return e;for(var a=[],r=0;r<e.length;r++){for(var l=!0,i=e[r],o=0;o<t.length;o++){var s=t[o],c=s.IsFiltered(s.Filter,i);if(c){l=!1;break}}l&&a.push(i)}return a}).extend({throttle:200})}function ExtractModels(e,t,n){var a=[];if(null==t)return a;for(var r=0;r<t.length;r++){var l=t[r],i=new n(l,e);a.push(i)}return a}function GetObservableArray(e){return"function"==typeof e?e:ko.observableArray(e)}function CompareCaseInsensitive(e,t){return null==e?null==t:null==t?!1:e.toUpperCase()<=t.toUpperCase()}function GetOption(e,t,n){var a={Name:e,Value:t,FilterValue:n};return a}function SortArray(e,t,n){if(null==e)return[];for(var a=0;a<e.length;a++)for(var r=e[a],l=a+1;l<e.length;l++){var i=e[l],o=n(r,i);o==t&&(e[l]=r,e[a]=i,r=i)}return e}function nl2br(e,t){var n=t||"undefined"==typeof t?"<br />":"<br>";return(e+"").replace(/([^>\r\n]?)(\r\n|\n\r|\r|\n)/g,"$1"+n+"$2")}var _eventPageModel=null;$(document).on("keydown.tabcontroller","#datetimepickerend",function(e){9==e.keyCode&&$(".zselect").trigger("click")}),$(document).on("keydown.tabcontroller-item",".zselect ul li:nth-last-child(2) input",function(e){9==e.keyCode&&$(".zselect ul").hide()}),$(document).ready(function(e){var t={},n={};ko.bindingHandlers.trimText={init:function(e,t,n,a){var r=ko.computed(function(){var e=ko.utils.unwrapObservable(t()),n=250,a=e.length>n?e.substring(0,n-1)+"...":e,a=a.replace(/&nbsp;/gi," "),a=a.trim();return a});return ko.applyBindingsToNode(e,{text:r},a),{controlsDescendantBindings:!0}}},_eventPageModel=new EventPageModel(t,n),ko.applyBindings(_eventPageModel);var a={action:"load_events",ids:adminIDs};e.post(ajaxurl,a,function(t){_eventPageModel.events(ExtractModels(_eventPageModel,JSON.parse(t),EventModel)),e("#events-loading-indicator").remove()});var a={action:"load_event_types"};e.post(ajaxurl,a,function(t){_eventPageModel.eventTypes(ExtractModels(_eventPageModel,JSON.parse(t),TypeModel)),e("select#municipality_multiselect").zmultiselect({live:"#selectedTypes",filter:!0,filterPlaceholder:"Filtrera...",filterResult:!0,filterResultText:"Visar",selectedText:["Valt","av"],selectAll:!0,selectAllText:["Markera alla","Avmarkera alla"],placeholder:"Välj evenemangstyp(er)…"})});var r=new Date;r.setDate(r.getDate()),e("#datetimepickerstart").datetimepicker({minDate:r,weeks:!0,lang:"se",timepicker:!1,format:"Y-m-d",formatDate:"Y-m-d",scrollMonth:!1,scrollTime:!1,scrollInput:!1,onShow:function(t){this.setOptions({maxDate:e("#datetimepickerend").val()?e("#datetimepickerend").val():!1})}}),e("#datetimepickerend").datetimepicker({weeks:!0,lang:"se",timepicker:!1,format:"Y-m-d",formatDate:"Y-m-d",scrollMonth:!1,scrollTime:!1,scrollInput:!1,onShow:function(t){this.setOptions({minDate:e("#datetimepickerstart").val()?e("#datetimepickerstart").val():!1})}}),e(document).on("click",'[data-reveal="eventModal"]',function(t){t.preventDefault();var n=e(".modal-image"),a=e(".modal-title"),r=e(".modal-link"),l=e(".modal-date"),i=e(".modal-description"),o=(e("#time-modal"),e("#organizer-modal"),e(".modal-ics a"));document.getElementById("event-times").style.display="block",e(".event-times-loading").show(),e(".event-times-item").remove(),document.getElementById("event-organizers").style.display="none";for(var s,c=_eventPageModel.events(),d=0;d<c.length;d++)if(c[d].EventID===this.id){s=c[d];break}var u={action:"load_event_dates",id:this.id,location:s.Location};e.post(ajaxurl,u,function(t){html="";for(var n=JSON.parse(t),a=0;a<n.length;a++)html+='<li class="event-times-item">',html+='<span class="event-date"><i class="fa fa-clock-o"></i> '+n[a].Date,n[a].Time&&(html+=" kl. "+n[a].Time),html+='</span><span class="event-location">'+u.location+"</span>",html+="</li>";e("#time-modal").prepend(html),e(".event-times-loading").hide(),0==n.length&&(document.getElementById("event-times").style.display="none")});var v={action:"load_event_organizers",id:this.id};e.post(ajaxurl,v,function(t){var n=JSON.parse(t);html="";for(var a=0;a<n.length;a++)html+="<li><span>"+n[a].Name+"</span></li>";e("#organizer-modal").html(html),n.length>0&&(document.getElementById("event-organizers").style.display="block")}),s.ImagePath?e(n).attr("src",s.ImagePath):e(n).attr("src",defaultImagePath),e(a).html(s.Name),s.Link?e(r).html('<a class="link-item" href="'+s.Link+'" target="blank">'+s.Link+"</a>").show():e(r).hide(),e(l).html(s.Date),e(i).html(nl2br(s.Description)),e(o).attr("href","?ics="+s.EventID)})});